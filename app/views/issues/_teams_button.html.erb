<%= javascript_tag do %>
    $(document).ready(function() {
        $('#main .user').each(function() {
            var userId = $(this)[0].pathname.split('/').pop();

            $('<a>', {
                'class': 'icon-teams',
                text: '',
                href: 'https://teams.microsoft.com/l/chat/0/0',
                click: function() {
                    $.ajax({
                        type: 'GET',
                        url: '/teams_button/user_email/' + userId,
                        dataType: 'json'
                    })
                    .done(function(response) {
                        if (response.email === null) {
                            alert('<%= l(:error_failed_to_get_email) %>');
                        } else {
                            var teamsUrl =
                                'https://teams.microsoft.com/l/chat/0/0?users=' + response.email +
                                '&message=' +
                                encodeURIComponent(document.title) + '%0D%0A' +
                                encodeURIComponent(location.href) + '%0D%0A' +
                                encodeURIComponent('refs #' + '<%= @issue.id %>');
                            window.open(teamsUrl);
                        }
                    })
                    .fail(function() {
                        alert('<%= l(:error_failed_to_get_email) %>');
                    });

                    return false;
                }
            }).insertAfter($(this));
        });
    });
<% end %>
